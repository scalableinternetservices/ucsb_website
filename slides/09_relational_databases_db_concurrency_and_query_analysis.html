<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Relational Databases: Concurrency Control and Query Analysis</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="theme/css/print.css">
    <link rel="stylesheet" media="screen, projection" href="theme/css/screen.css">
    
    
      
      <link rel="stylesheet" href="theme/css/custom.css">
      
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="theme/js/slides.js"></script>
    
    
    
    <!-- /Javascripts -->

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67332703-1', 'auto');
      ga('send', 'pageview');
    </script>
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide title slide-1">
          <div class="inner">
            
            <header><h1>Relational Databases: Concurrency Control and Query Analysis</h1></header>
            
            
            <section><p><strong>CS290B</strong></p>
<p>Dr. Bryce Boe</p>
<p>October 22, 2015</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              1/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-2">
          <div class="inner">
            
            <header><h1>Today's Agenda</h1></header>
            
            
            <section><ul>
<li>TODO</li>
<li>Server-side Caching in Rails Review</li>
<li>Motivation</li>
<li>A Stable Data Layer</li>
<li>Database Concurrency Control</li>
<li>Query Analysis</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              2/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-3">
          <div class="inner">
            
            <header><h1>TODO</h1></header>
            
            
            <section><h2>By end of lab</h2>
<ul>
<li>As a team, launch your application on AWS</li>
<li>Individually, confirm that you are able to SSH into your instance</li>
<li>Shutdown your AWS stack(s)</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              3/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-4">
          <div class="inner">
            
            <header><h1>Server-side Caching in Rails Review</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              4/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-5">
          <div class="inner">
            
            <header><h1>Rails Russian Doll Caching</h1></header>
            
            
            <section><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">cache</span><span class="p">(</span><span class="n">cache_key_for_submission_table</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span><span class="x"></span>

<span class="x">&lt;h3&gt;Submissions&lt;/h3&gt;</span>
<span class="x">&lt;table class=&quot;table&quot;&gt;</span>
<span class="x">  &lt;thead&gt;</span>
<span class="x">    &lt;tr&gt;...&lt;/tr&gt;</span>
<span class="x">  &lt;/thead&gt;</span>

<span class="x">  &lt;tbody&gt;</span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="vi">@submissions</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">submission</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">      </span><span class="cp">&lt;%</span> <span class="n">cache</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span><span class="x"> ... </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    </span><span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;/tbody&gt;</span>
<span class="x">&lt;/table&gt;</span>

<span class="x">...</span>

<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              5/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-6">
          <div class="inner">
            
            <header><h1>Low-level Rails Caching</h1></header>
            
            
            <section><p>You can use the same built-in mechanisms to manually cache anything:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">competing_price</span>
    <span class="no">Rails</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">cache_key</span><span class="si">}</span><span class="s2">/competing_price&quot;</span><span class="p">,</span>
                      <span class="ss">expires_in</span><span class="p">:</span> <span class="mi">12</span><span class="o">.</span><span class="n">hours</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">Competitor</span><span class="o">::</span><span class="no">API</span><span class="o">.</span><span class="n">find_price</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              6/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-7">
          <div class="inner">
            
            <header><h1>Motivation</h1></header>
            
            
            <section><p>After today you should...</p>
<ul>
<li>understand the importance of relational databases in architecting scalable
  Internet systems</li>
<li>understand how to design with concurrency in mind</li>
<li>have a basic idea regarding how to speed up your data layer<ul>
<li>where to start</li>
<li>Rails-specific techniques</li>
<li>be able to identity the source of slowness in a SQL query</li>
</ul>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              7/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-8">
          <div class="inner">
            
            <header><h1>Stateful Requests</h1></header>
            
            
            <section><p><img alt="Database connectivity" src="img/app_server_to_database.png" /></p>
<p>We have many stateless application servers responding to requests.</p>
<p>Clients can be served by any application servers.</p>
<p>Client requests regularly include data updates.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              8/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code img-left slide-9">
          <div class="inner">
            
            <header><h1>Application Server <em>Needs</em></h1></header>
            
            
            <section><p><img alt="Database connectivity" src="img/app_server_to_database.png" /></p>
<ul>
<li>
<p>Data needs to be shared between requests and servers</p>
</li>
<li>
<p>Access to data shouldn't be slow</p>
</li>
<li>
<p>High availability of shared data</p>
</li>
<li>
<p>Utilizing the data layer should be intuitive:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">david</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">100</span>
  <span class="n">david</span><span class="o">.</span><span class="n">withdrawal</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
  <span class="n">mary</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</td></tr></table>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              9/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-10">
          <div class="inner">
            
            <header><h1>Data Layer Options</h1></header>
            
            
            <section><p><img alt="Database connectivity" src="img/app_server_to_database.png" /></p>
<p>There are quite a few existing solutions for a <em>stable</em> data layer.</p>
<h2>Relational (SQL)</h2>
<ul>
<li>MySQL (MariaDB, Percona)</li>
<li>PostgreSQL</li>
<li>Oracle</li>
<li>MS SQL</li>
</ul>
<h2>Non-relational (NoSQL)</h2>
<ul>
<li>Cassandra</li>
<li>MongoDB</li>
<li>Redis</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              10/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-11">
          <div class="inner">
            
            <header><h1>SQL v. NoSQL</h1></header>
            
            
            <section><p><img alt="Database connectivity" src="img/app_server_to_database.png" /></p>
<h2>Relational Databases...</h2>
<ul>
<li>are a general-purpose persistence layer</li>
<li>offer more features</li>
<li>have a limited ability to scale horizontally</li>
</ul>
<h2>Non-relational Databases...</h2>
<ul>
<li>often are more specialized</li>
<li>require more from the application layer</li>
<li>are better at scaling horizontally</li>
</ul>
<p>If your needs fit within a RDBMS's (relational database management system)
ability to scale, they tend to be best. If your scaling needs exceed RDBMS
capabilities, go non-relational.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              11/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-12">
          <div class="inner">
            
            <header><h1>Database Outline</h1></header>
            
            
            <section><p><img alt="Database connectivity" src="img/app_server_to_database.png" /></p>
<h2>Today we will discuss:</h2>
<ul>
<li>Relational databases</li>
<li>Concurrency control</li>
<li>SQL query analysis</li>
</ul>
<h2>Later we will discuss:</h2>
<ul>
<li>Scaling options for relational databases:<ul>
<li>Sharding</li>
<li>Service Oriented Architectures (SOA)</li>
<li>Distinguishing reads from writes</li>
</ul>
</li>
<li>A survey of NoSQL options</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              12/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-13">
          <div class="inner">
            
            <header><h1>Database Transactions</h1></header>
            
            
            <section><p>Transactions are a database concept that allows a system to guarantee certain
semantic properties.</p>
<p>Transactions provide control over concurrency.</p>
<p>Having rigorously defined guarantees means we can build correct systems using
these databases.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              13/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-14">
          <div class="inner">
            
            <header><h1>Database Transaction History</h1></header>
            
            
            <section><h2>Mid 1970's, IBM System R's Research Storage System (RSS)</h2>
<ul>
<li>First system to implement SQL</li>
<li>Introduced formal notions of transactions and serializability</li>
</ul>
<p>Jim Gray (1998 Turing Award Winner) had a significant role in the project for
the introduction of transactions.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              14/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-15">
          <div class="inner">
            
            <header><h1>Database ACID Properties</h1></header>
            
            
            <section><h2>Atomicity</h2>
<ul>
<li>Complete everything, or do nothing</li>
<li>No partial application of a transaction</li>
</ul>
<h2>Consistency</h2>
<ul>
<li>The database should be consistent both at the beginning and end of a
  transaction</li>
<li>Consistency is defined by the integrity constraints (e.g., foreign keys, <code>NOT
  NULL</code>, etc.)</li>
</ul>
<h2>Isolation</h2>
<ul>
<li>A transaction should not see the effects of other uncommitted transactions</li>
</ul>
<h2>Durability</h2>
<ul>
<li>Once committed, the transaction's effects should not disappear</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              15/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-16">
          <div class="inner">
            
            <header><h1>Overlapping Concerns</h1></header>
            
            
            <section><p><strong>Atomicity</strong> and <strong>Durability</strong> are related and are generally provided by
<em>journaling</em>.</p>
<p><strong>Consistency</strong> and <strong>Isolation</strong> are provided by concurrency control (usually
implemented via locking).</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              16/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide table-center slide-17">
          <div class="inner">
            
            <header><h1>Definition: Schedule</h1></header>
            
            
            <section><p>A <strong>schedule</strong> is an abstract model used to describe the execution of
transactions that run in a database.</p>
<table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
<th align="center">T3</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">R(X)</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">W(X)</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Commit</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">R(Y)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(Y)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Commit</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">R(Z)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">W(Z)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Commit</td>
</tr>
</tbody>
</table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              17/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-18">
          <div class="inner">
            
            <header><h1>Conflicting Actions</h1></header>
            
            
            <section><p>Two actions are said to be in conflict if:</p>
<ul>
<li>the actions belong to different transactions</li>
<li>at least one of the actions is a write operation</li>
<li>the actions access the same object (read or write)</li>
</ul>
<h2>Conflicting Actions</h2>
<table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
<th align="center">T3</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">R(X)</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(X)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">W(X)</td>
</tr>
</tbody>
</table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              18/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide center slide-19">
          <div class="inner">
            
            <header><h1>Non-Conflicting Examples</h1></header>
            
            
            <section><h2>All reads</h2>
<table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
<th align="center">T3</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">R(X)</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">R(X)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">R(X)</td>
</tr>
</tbody>
</table>
<h2>Write to different object</h2>
<table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
<th align="center">T3</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">R(X)</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(Y)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">R(X)</td>
</tr>
</tbody>
</table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              19/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-20">
          <div class="inner">
            
            <header><h1>Question</h1></header>
            
            
            <section><blockquote>
<p>Can we blindly execute transaction in parallel?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              20/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-21">
          <div class="inner">
            
            <header><h1>Answer</h1></header>
            
            
            <section><blockquote>
<p>Can we blindly execute transaction in parallel?</p>
</blockquote>
<p><strong>No</strong></p>
<ul>
<li>Dirty Read Problem</li>
<li>Incorrect Summary Problem</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              21/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide table-center slide-22">
          <div class="inner">
            
            <header><h1>Dirty Read Problem</h1></header>
            
            
            <section><p>A transaction (T2) reads a value written by another transaction (T1) that is
later <em>aborted</em> (its actions are rolled back).</p>
<p>The result of the T2 transaction will put the database in an incorrect state.</p>
<table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">W(X)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">R(X)</td>
</tr>
<tr>
<td align="center">Abort</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(Y)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Commit</td>
</tr>
</tbody>
</table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              22/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide table-center slide-23">
          <div class="inner">
            
            <header><h1>Incorrect Summary Problem</h1></header>
            
            
            <section><p>A transaction (T1) computes a summary over the values of all the instances of a
repeated data-item. While that occurs, another transaction (T2) updates some
instances of data-item.</p>
<p>The resulting summary will not reflect a correct result for any deterministic
order of the transactions (T1 then T2, or T2 then T1).</p>
<table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">R(X*)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">R(X*)</td>
<td align="center">W(X^n)</td>
</tr>
<tr>
<td align="center">R(X*)</td>
<td align="center">Commit</td>
</tr>
<tr>
<td align="center">R(X*)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">W(Y)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Commit</td>
<td align="center"></td>
</tr>
</tbody>
</table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              23/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-24">
          <div class="inner">
            
            <header><h1>Schedule Types</h1></header>
            
            
            <section><h2>A schedule is <em>serial</em> if</h2>
<ul>
<li>the transactions are executed non-interleaved</li>
</ul>
<h2>Two schedules are <em>conflict equivalent</em> if</h2>
<ul>
<li>they involve the same actions of the same transactions</li>
<li>every pair of conflicting actions are ordered in the same way</li>
</ul>
<h2>A schedule is <em>conflict serializable</em> if</h2>
<ul>
<li>the schedule is <strong>conflict equivalent</strong> to a <strong>serial</strong> schedule</li>
</ul>
<h2>A schedule is <em>recoverable</em> if</h2>
<ul>
<li>transactions commit only after all transactions whose changes they read,
  commit</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              24/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide table-left slide-25">
          <div class="inner">
            
            <header><h1>Not Conflict Serializable</h1></header>
            
            
            <section><table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">R(A)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">W(A)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">R(A)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(A)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">R(B)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(B)</td>
</tr>
<tr>
<td align="center">R(B)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">W(B)</td>
<td align="center"></td>
</tr>
</tbody>
</table>
<p>When transactions are serialized, it is not conflict equivalent to either of:</p>
<table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">R(A)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">W(A)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">R(B)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">W(B)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">R(A)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(A)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">R(B)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(B)</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"></td>
<td align="center">R(A)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(A)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">R(B)</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">W(B)</td>
</tr>
<tr>
<td align="center">R(A)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">W(A)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">R(B)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">W(B)</td>
<td align="center"></td>
</tr>
</tbody>
</table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              25/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-26">
          <div class="inner">
            
            <header><h1>Why Serializable?</h1></header>
            
            
            <section><p><img alt="Database connectivity" src="img/app_server_to_database.png" /></p>
<blockquote>
<p>Why is it important that we have a serializable schedule?</p>
<p>Why not simply execute serially?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              26/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-27">
          <div class="inner">
            
            <header><h1>Serial Schedule</h1></header>
            
            
            <section><p>Having a serial schedule is important for consistent results. For example it is
good when you are keeping track of your bank balance in the database.</p>
<p>A serial execution of transactions is safe but <em>slow</em>.</p>
<p>Most general purpose relational databases default to employing
conflict-serializable and recoverable schedules.</p>
<blockquote>
<p>How do these RDBMS employ conflict-serializable and recoverable schedules?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              27/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-28">
          <div class="inner">
            
            <header><h1>Database Locks</h1></header>
            
            
            <section><p>In order to implement a database whose schedules are both conflict serializable
and recoverable locks are used.</p>
<ul>
<li>
<p>A lock is a system object associated with a shared resource such as a data
  item, a row, or a page in memory.</p>
</li>
<li>
<p>A database lock may need to be acquired by a transaction before accessing the
  object.</p>
</li>
<li>
<p>Locks prevent undesired, incorrect, or inconsistent operations on shared
resources by concurrent transactions.</p>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              28/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-29">
          <div class="inner">
            
            <header><h1>Types of Database Locks</h1></header>
            
            
            <section><h2>Write-lock</h2>
<ul>
<li>Blocks writes and reads</li>
<li>Also called <strong>exclusive lock</strong></li>
</ul>
<h2>Read-lock</h2>
<ul>
<li>Blocks writes</li>
<li>Also called <strong>shared lock</strong> (other reads can happen concurrently)</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              29/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-30">
          <div class="inner">
            
            <header><h1>Two-Phase Locking</h1></header>
            
            
            <section><p>Two-phase locking (2PL) is a concurrency control method that guarantees
serializability.</p>
<p>The two phases are:</p>
<ul>
<li>Acquire Locks</li>
<li>Release Locks</li>
</ul>
<h2>Two-phase locking Protocol</h2>
<ul>
<li>Each transaction must obtain a <em>shared</em> lock on an object before reading.</li>
<li>Each transaction must obtain an <em>exclusive</em> lock on an object before writing.</li>
<li>If a transaction holds an exclusive lock on an object, no other transaction
  can obtain any lock on that object.</li>
<li>A transaction cannot request additional locks once it releases any locks.</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              30/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide table-center slide-31">
          <div class="inner">
            
            <header><h1>Two-Phase Locking: Potential Issue</h1></header>
            
            
            <section><p>During the second phase locks can be released as soon as they are no longer
needed. This permits other transactions to obtain those locks.</p>
<table>
<thead>
<tr>
<th align="center">T1</th>
<th align="center">T2</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">R(A)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">W(A)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">unlock(A)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">R(A)</td>
</tr>
<tr>
<td align="center">...</td>
<td align="center">...</td>
</tr>
<tr>
<td align="center">abort</td>
<td align="center"></td>
</tr>
</tbody>
</table>
<blockquote>
<p>What happens to T2 when T1 aborts the transaction?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              31/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-32">
          <div class="inner">
            
            <header><h1>Strong Strict Two-Phase Locking</h1></header>
            
            
            <section><p>2PL can result in cascading aborts.</p>
<p>SS2PL allows only conflict serializable schedules.</p>
<h1>Strong Strict Two-Phase Locking Protocol</h1>
<ul>
<li>Each transaction must obtain a <em>shared</em> lock on an object before reading.</li>
<li>Each transaction must obtain an <em>exclusive</em> lock on an object before writing.</li>
<li>If a transaction holds an exclusive lock on an object, no other transaction
  can obtain any lock on that object.</li>
<li>All locks held by a transaction are released when the transaction completes.</li>
</ul>
<p>This approach avoids the problem with cascading aborts.</p>
<blockquote>
<p>What is the downside to SS2PL?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              32/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-33">
          <div class="inner">
            
            <header><h1>Concurrency Control in Rails</h1></header>
            
            
            <section><p><img alt="Database connectivity" src="img/app_server_to_database.png" /></p>
<p>We have many application servers running our application.</p>
<p>We are using a relational database to ensure that each requests observes a
consistent view of the database.</p>
<blockquote>
<p>What it required in rails to obtain this consistency?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              33/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-34">
          <div class="inner">
            
            <header><h1>Concurrency Control in Rails</h1></header>
            
            
            <section><p>Rails uses two types of concurrency control:</p>
<h2>Optimistic Locking</h2>
<p>Assume that database modifications are going to succeed. Throw an exception
when they do not.</p>
<h2>Pessimistic Locking</h2>
<p>Ensure that databases modifications will succeed by explicitly avoiding
conflict.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              34/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-35">
          <div class="inner">
            
            <header><h1>Optimistic Locking in Rails</h1></header>
            
            
            <section><p>Any ActiveRecord model will automatically utilize optimistic locking if an
integer <code>lock_version</code> field is added to the object's table.</p>
<p>Whenever an such an ActiveRecord object is read from the database, that object
contains its associated <code>lock_version</code>.</p>
<p>When an update for the object occurs, Rails compares the object's
<code>lock_version</code> to the most recent one in the database.</p>
<p>If they differ a <code>StaleObjectException</code> is thrown.</p>
<p>Otherwise, the data is written to the database, and the <code>lock_version</code> value is
incremented.</p>
<p>This optimistic locking is an application-level construct. The database does
nothing more than storing the <code>lock_version</code> values.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              35/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-36">
          <div class="inner">
            
            <header><h1>Optimistic Locking Example</h1></header>
            
            
            <section><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">c1</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">c1</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="s2">&quot;male&quot;</span>

<span class="n">c2</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">c2</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="s2">&quot;female&quot;</span>

<span class="n">c1</span><span class="o">.</span><span class="n">save!</span>  <span class="c1"># Succeeds (It&#39;s a boy!)</span>
<span class="n">c2</span><span class="o">.</span><span class="n">save!</span>  <span class="c1"># throws StaleObjectException</span>
</pre></div>
</td></tr></table>
<h2>Strengths</h2>
<ul>
<li>Predictable performance</li>
<li>Lightweight</li>
</ul>
<h2>Weaknesses</h2>
<ul>
<li>Have to write error handling code</li>
<li>(or) errors will propagate to your users</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              36/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-37">
          <div class="inner">
            
            <header><h1>Pessimistic Locking in Rails</h1></header>
            
            
            <section><p>Easily done by calling <code>lock</code> along with ActiveRecord <code>find</code>.</p>
<p>Whenever an ActiveRecord object is read from the database with that option an
exclusive lock is acquired for the object.</p>
<p>While this lock is held, the database prevents others from obtaining the lock,
reading from, and writing to the object. The others are blocked until the
object is unlocked.</p>
<p>Implemented using the <code>SELECT FOR UPDATE</code> SQL.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              37/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-38">
          <div class="inner">
            
            <header><h1>Pessimistic Locking Example</h1></header>
            
            
            <section><p>Request 1</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">transaction</span> <span class="k">do</span>
  <span class="n">c1</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">c1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Daniel&#39;</span>
  <span class="n">c1</span><span class="o">.</span><span class="n">save!</span>  <span class="c1"># works fine</span>
<span class="k">end</span>
</pre></div>
</td></tr></table>
<p>Request 2</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">transaction</span> <span class="k">do</span>
  <span class="n">c2</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">c2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Evelyn&#39;</span>
  <span class="n">c2</span><span class="o">.</span><span class="n">save!</span>  <span class="c1"># works fine</span>
<span class="k">end</span>
</pre></div>
</td></tr></table>
<p>This approach works great, yet it is not commonly used.</p>
<blockquote>
<p>What could go wrong?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              38/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-39">
          <div class="inner">
            
            <header><h1>Pessimistic Locking Issue 1</h1></header>
            
            
            <section><blockquote>
<p>What could go wrong? (blocking)</p>
</blockquote>
<p>Request 1</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">transaction</span> <span class="k">do</span>
  <span class="n">c1</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">c1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Daniel&#39;</span>
  <span class="n">my_long_procedure</span>
  <span class="n">c1</span><span class="o">.</span><span class="n">save!</span>
<span class="k">end</span>
</pre></div>
</td></tr></table>
<p>Request 2</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">transaction</span> <span class="k">do</span>
  <span class="n">c2</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">c2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Evelyn&#39;</span>
  <span class="n">c2</span><span class="o">.</span><span class="n">save!</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              39/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-40">
          <div class="inner">
            
            <header><h1>Pessimistic Locking: Deadlock</h1></header>
            
            
            <section><p>Request 1</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">transaction</span> <span class="k">do</span>
  <span class="n">fam</span> <span class="o">=</span> <span class="no">Family</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">c1</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">c1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Daniel&#39;</span>
  <span class="n">c1</span><span class="o">.</span><span class="n">save!</span>
  <span class="n">fam</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">fam</span><span class="o">.</span><span class="n">save!</span>
<span class="k">end</span>
</pre></div>
</td></tr></table>
<p>Request 2</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">transaction</span> <span class="k">do</span>
  <span class="n">c2</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">c2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Evelyn&#39;</span>
  <span class="n">c2</span><span class="o">.</span><span class="n">save!</span>
  <span class="n">fam</span> <span class="o">=</span> <span class="no">Family</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">fam</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">fam</span><span class="o">.</span><span class="n">save!</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              40/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-41">
          <div class="inner">
            
            <header><h1>Pessimistic Locking: Summary</h1></header>
            
            
            <section><h2>Strengths</h2>
<ul>
<li>Failed transactions are incredibly rare or nonexistent</li>
</ul>
<h2>Weaknesses</h2>
<ul>
<li>Have to worry about deadlocks and avoiding them</li>
<li>Performance is less predictable</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              41/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-42">
          <div class="inner">
            
            <header><h1>Challenge 1</h1></header>
            
            
            <section><blockquote>
<p>Which form of locking would you choose?</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">transaction</span> <span class="k">do</span>
  <span class="n">determine_auction_winner</span><span class="p">()</span>
  <span class="n">send_email_to_winner</span><span class="p">()</span>
  <span class="n">save_auction_outcome</span><span class="p">()</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              42/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-43">
          <div class="inner">
            
            <header><h1>Challenge 2</h1></header>
            
            
            <section><blockquote>
<p>Which form of locking would you choose?</p>
</blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">transaction</span> <span class="k">do</span>
  <span class="n">record_facebook_like</span><span class="p">()</span>
  <span class="n">update_global_counter_of_all_likes_ever</span><span class="p">()</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              43/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-44">
          <div class="inner">
            
            <header><h1>Next Step</h1></header>
            
            
            <section><p>We now have a Rails app connected to MySQL and it is slower than you'd like.</p>
<p>You think the bottleneck may be the database.</p>
<blockquote>
<p>How do we find out?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              44/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-45">
          <div class="inner">
            
            <header><h1>Demo App Database Optimizations</h1></header>
            
            
            <section><p><img alt="Submissions Index View" src="img/demo_submissions_index.png" /></p>
<p>Let's use an example from the Demo app!</p>
<p>By changing the way you interact with the Rails ORM (ActiveRecord) you can
significantly improve performance.</p>
<p>The following examples are all contained in the <em>database_optimizations</em> branch
on github.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              45/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-46">
          <div class="inner">
            
            <header><h1>Demo App ActiveRecord Time</h1></header>
            
            
            <section><p>With the Demo app's <em>master</em> branch deployed on a <code>m3_medium</code> instance
with:</p>
<p><img alt="Submissions Index View" src="img/demo_submissions_index.png" /></p>
<ul>
<li>20 Communities</li>
<li>400 Submissions</li>
<li>8000 Comments</li>
</ul>
<p>A request to <code>/</code> resulted in:</p>
<p>Completed 200 OK
ActiveRecord: 220.6ms.</p>
<blockquote>
<p>Why so slow?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              46/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-47">
          <div class="inner">
            
            <header><h1>Demo App Investigation</h1></header>
            
            
            <section><p><strong>First Step</strong>: Find out what Rails is doing.</p>
<p>In <em>development</em> mode, Rails will output the SQL it generates and executes to
the application server log.</p>
<p>To (temporarily) enable this in <em>production</em> mode, change
<code>config/environments/production.rb</code> to contain:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="ss">:debug</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              47/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-48">
          <div class="inner">
            
            <header><h1>Submission Index Controller and View</h1></header>
            
            
            <section><p>Controller</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SubmissionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@submissions</span> <span class="o">=</span> <span class="no">Submission</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
 <span class="k">end</span>
</pre></div>
</td></tr></table>
<p>View</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@submissions</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">submission</span><span class="o">|</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">  &lt;tr&gt;</span>
<span class="x">    &lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">submission</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x">&lt;/td&gt;</span>
<span class="x">    &lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">submission</span><span class="o">.</span><span class="n">url</span> <span class="cp">%&gt;</span><span class="x">&lt;/td&gt;</span>
<span class="x">    &lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">submission</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x">&lt;/td&gt;</span>
<span class="x">    &lt;td&gt;</span>
<span class="x">      </span><span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">submission</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> comments&quot;</span><span class="p">,</span>
                  <span class="n">submission</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary btn-xs&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
<span class="x">    &lt;/td&gt;</span>
<span class="x">  &lt;/tr&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span><span class="x"></span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              48/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-49">
          <div class="inner">
            
            <header><h1>Generated SQL Statements</h1></header>
            
            
            <section><pre><code>Processing by SubmissionsController#index as HTML
Submission Load (0.5ms)  SELECT `submissions`.* FROM `submissions`
Community Load (0.3ms)  SELECT  `communities`.* FROM `communities` WHERE `communities`.`id` = 1 LIMIT 1
SELECT COUNT(*) FROM `comments` WHERE `comments`.`submission_id` = 1
SELECT  `communities`.* FROM `communities` WHERE `communities`.`id` = 1 LIMIT 1  [["id", 1]]
SELECT COUNT(*) FROM `comments` WHERE `comments`.`submission_id` = 2
SELECT  `communities`.* FROM `communities` WHERE `communities`.`id` = 1 LIMIT 1  [["id", 1]]
SELECT COUNT(*) FROM `comments` WHERE `comments`.`submission_id` = 3
SELECT  `communities`.* FROM `communities` WHERE `communities`.`id` = 1 LIMIT 1  [["id", 1]]
...
SELECT  `communities`.* FROM `communities` WHERE `communities`.`id` = 20 LIMIT 1  [["id", 20]]
SELECT COUNT(*) FROM `comments` WHERE `comments`.`submission_id` = 400
</code></pre>
<p>That is a lot of <code>SELECT</code> queries!</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              49/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-50">
          <div class="inner">
            
            <header><h1>Number of Queries Bottleneck</h1></header>
            
            
            <section><p>We are issuing a ton of <code>SELECT</code> queries. The overhead associated with each is
slowing us down.</p>
<blockquote>
<p>How can we fix this problem?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              50/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-51">
          <div class="inner">
            
            <header><h1>Number of Queries Bottleneck</h1></header>
            
            
            <section><p>We are issuing a ton of <code>SELECT</code> queries. The overhead associated with each is
slowing us down.</p>
<blockquote>
<p>How can we fix this problem?</p>
</blockquote>
<h2>Issue fewer queries.</h2>
<ul>
<li>Do not ask for the community each time</li>
<li>Do not ask for the number of comments each time</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              51/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-52">
          <div class="inner">
            
            <header><h1>Reducing Queries in Rails</h1></header>
            
            
            <section><p>Without <code>includes</code></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SubmissionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@submissions</span> <span class="o">=</span> <span class="no">Submission</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
 <span class="k">end</span>
</pre></div>
</td></tr></table>
<p>With <code>includes</code></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SubmissionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@submissions</span> <span class="o">=</span> <span class="no">Submission</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span>
                             <span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:community</span><span class="p">)</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
 <span class="k">end</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              52/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-53">
          <div class="inner">
            
            <header><h1>With Includes Result</h1></header>
            
            
            <section><pre><code>Result: ActiveRecord 39.6ms

Submission Load (0.9ms)  SELECT `submissions`.* FROM `submissions`
Comment Load (38.3ms)  SELECT `comments`.* FROM `comments` WHERE `comments`.`submission_id` IN (1, 2,... 399, 400)
Community Load (0.4ms)  SELECT `communities`.* FROM `communities` WHERE `communities`.`id` IN (1, 2, ...19, 20)
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              53/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-54">
          <div class="inner">
            
            <header><h1>SQL Explain</h1></header>
            
            
            <section><p>Sometimes things are still slow even when you have minimized the number of
queries.</p>
<p>SQL provides an <code>EXPLAIN</code> statement that can be used to analyze individual
queries.</p>
<p>When a query starts with <code>EXPLAIN</code>...</p>
<ul>
<li>the query is not actually executed</li>
<li>the produced output will help us identify potential improvements</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              54/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-55">
          <div class="inner">
            
            <header><h1>SQL Explain Example</h1></header>
            
            
            <section><pre><code>EXPLAIN SELECT COUNT(DISTINCT `submissions`.`id`) FROM `submissions`
JOIN `comments` WHERE `comments`.`submission_id` = `submissions`.`id`
AND `comments`.`message` = 'This is not a test!'\G

*************************** 1. row ***************************
id: 1
select_type: SIMPLE
table: submissions
type: index
possible_keys: PRIMARY
key: index_submissions_on_community_id
key_len: 5
ref: NULL
rows: 50
Extra: Using index
*************************** 2. row ***************************
id: 1
select_type: SIMPLE
table: comments
type: ref
possible_keys: index_comments_on_submission_id
key: index_comments_on_submission_id
key_len: 5
ref: rails_app.submissions.id
rows: 1
Extra: Using where
2 rows in set (0.00 sec)
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              55/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-56">
          <div class="inner">
            
            <header><h1>Understanding the Explain Output</h1></header>
            
            
            <section><p>The following are the most important fields for performance analysis:</p>
<table>
<thead>
<tr>
<th align="left">Field</th>
<th align="left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">select_type</td>
<td align="left">The SELECT type</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">The join type</td>
</tr>
<tr>
<td align="left">possible_keys</td>
<td align="left">The indexes available to be chosen</td>
</tr>
<tr>
<td align="left">key</td>
<td align="left">The index actually chosen</td>
</tr>
<tr>
<td align="left">rows</td>
<td align="left">Estimate number of rows to examine</td>
</tr>
</tbody>
</table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              56/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-57">
          <div class="inner">
            
            <header><h1>Explain Field: select_type</h1></header>
            
            
            <section><p><code>select_type</code> indicates the type of select statement being performed.</p>
<p>Most types are fine, but two indicate potential performance problems:</p>
<ul>
<li><strong>Dependent Subquery</strong>: reevaluated for every different value of the outer
  query</li>
<li><strong>Uncacheable Subquery</strong>: reevaluated for every value of the outer query</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              57/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-58">
          <div class="inner">
            
            <header><h1>Explain Field: type</h1></header>
            
            
            <section><p><code>type</code> indicates the type of JOIN being used. From best to worst:</p>
<ul>
<li><strong>system</strong>: The table only has one row</li>
<li><strong>const</strong>: From uniqueness, we know only one row can match</li>
<li><strong>eq_ref</strong>, <strong>ref</strong>: Only one row at most can match from the previous table</li>
<li><strong>fulltext</strong>: MySQL fulltext index</li>
<li><strong>ref_or_null</strong>: Like ref, but also includes <em>NULL</em> values</li>
<li><strong>index_merge</strong>: Uses multiple indexes to obtain the result</li>
<li><strong>unique_subquery</strong></li>
<li><strong>index_subquery</strong></li>
<li><strong>range</strong>: Only rows in a given range are retrieved, but can use index</li>
<li><strong>index</strong>: Full table scan, but can scan index instead of actual table</li>
<li><strong>ALL</strong>: Full table scan</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              58/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-59">
          <div class="inner">
            
            <header><h1>Explain Fields: possible_keys &amp; key</h1></header>
            
            
            <section><p><code>possible_keys</code> lists the indexes that could possibly be used to perform the
query. <code>key</code> indicates which key was actually chosen to perform the query.</p>
<p>If you don't like the index that the database is using, you can tell it to
ignore the index by adding <code>IGNORE INDEX</code> to the query.</p>
<p>When <code>possible_keys</code> is NULL, it's very likely one or more indexes should be
added to the appropriate columns.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              59/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-60">
          <div class="inner">
            
            <header><h1>Explain Field: rows</h1></header>
            
            
            <section><p>The <code>rows</code> field indicates the database's estimate of how many rows may need
to be read to perform the query.</p>
<p>The larger the number, the more time the query will take.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              60/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-61">
          <div class="inner">
            
            <header><h1>SQL Optimizations</h1></header>
            
            
            <section><p>There are three primary ways to optimize SQL queries:</p>
<ul>
<li>Add or modify indexes</li>
<li>Modify the table structure</li>
<li>Directly optimize the query</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              61/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-62">
          <div class="inner">
            
            <header><h1>SQL Indexes</h1></header>
            
            
            <section><blockquote>
<p>What is an index?</p>
</blockquote>
<p>An index is a fast, ordered, compact structure (B-tree) for identifying row
locations.</p>
<p>When an index is provided on a column that is to be filtered (searching for a
particular item), the database is able to quickly find that information.</p>
<p>Indexes can exist on a single column, or across multiple columns. Multi-column
indexes are useful when filtering on two columns (e.g., CS classes that are not
full).</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              62/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-63">
          <div class="inner">
            
            <header><h1>Adding Indexes in Rails</h1></header>
            
            
            <section><p>To add an index on the <code>name</code> field of the <code>Product</code> table, create a migration
containing:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddNameIndexProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:name</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              63/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-64">
          <div class="inner">
            
            <header><h1>Related: Foreign Keys</h1></header>
            
            
            <section><p>By default, when dealing with relationships between ActiveRecord objects, Rails
will validate the constraints in the application layer.</p>
<p>For example, an <code>Employee</code> object should have a <code>Company</code> that they work for.</p>
<p>Assuming the relationship is defined properly, Rails will enforce that when
creating an <code>Employee</code>, the associated <code>Company</code> exists.</p>
<p>Many databases, have built-in support for enforcing such constraints. With
rails, one can use the <code>Foreigner</code> gem to take advantage of the database's
foreign key support.</p>
<p>After installing the gem, create a migration:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddForeignKeyToOrders</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_foreign_key</span> <span class="ss">:employees</span><span class="p">,</span> <span class="ss">:companies</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              64/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide slide-65">
          <div class="inner">
            
            <header><h1>Optimize the Table Structure</h1></header>
            
            
            <section><p>Indexes work best when they can be kept in memory.</p>
<p>Sometimes changing the field type, or index length can provide significant
memory savings.</p>
<p>If appropriate some options are:</p>
<ul>
<li>Reduce the length of a VARCHAR index if appropriate</li>
<li>Use a smaller unsigned integer type</li>
<li>Use an integer or enum field for statuses rather than a text-based value</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              65/66
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 09_relational_databases_db_concurrency_and_query_analysis.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-66">
          <div class="inner">
            
            <header><h1>Directly Optimize the Query</h1></header>
            
            
            <section><p>Before</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">explain</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">txns</span> <span class="k">where</span> <span class="n">parent_id</span> <span class="o">-</span> <span class="mi">1600</span> <span class="o">=</span> <span class="mi">16340</span><span class="p">;</span>

<span class="n">select_type</span><span class="p">:</span> <span class="k">SIMPLE</span>
<span class="k">table</span><span class="p">:</span> <span class="n">txns</span>
<span class="k">type</span><span class="p">:</span> <span class="k">index</span>
<span class="k">key</span><span class="p">:</span> <span class="n">index_txns_on_reverse_txn_id</span>
<span class="k">rows</span><span class="p">:</span> <span class="mi">439186</span>
<span class="n">Extra</span><span class="p">:</span> <span class="k">Using</span> <span class="k">where</span><span class="p">;</span> <span class="k">Using</span> <span class="k">index</span>
</pre></div>
</td></tr></table>
<p>After</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">explain</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">txns</span> <span class="k">where</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">16340</span> <span class="o">+</span> <span class="mi">1600</span>

<span class="n">select_type</span><span class="p">:</span> <span class="k">SIMPLE</span>
<span class="k">table</span><span class="p">:</span> <span class="n">txns</span>
<span class="k">type</span><span class="p">:</span> <span class="n">const</span>
<span class="k">key</span><span class="p">:</span> <span class="n">index_txns_on_reverse_txn_id</span>
<span class="k">rows</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Extra</span><span class="p">:</span> <span class="k">Using</span> <span class="k">index</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="09_relational_databases_db_concurrency_and_query_analysis.md">09_relational_databases_db_concurrency_and_query_analysis.md</a>
            </aside>
            
            <aside class="page_number">
              66/66
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1">Relational Databases: Concurrency Control and Query Analysis</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide2">Today's Agenda</a></th>
        <td><a href="#slide2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide3">TODO</a></th>
        <td><a href="#slide3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide4">Server-side Caching in Rails Review</a></th>
        <td><a href="#slide4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide5">Rails Russian Doll Caching</a></th>
        <td><a href="#slide5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide6">Low-level Rails Caching</a></th>
        <td><a href="#slide6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide7">Motivation</a></th>
        <td><a href="#slide7">7</a></td>
      </tr>
      
      
      <tr id="toc-row-8">
        <th><a href="#slide8">Stateful Requests</a></th>
        <td><a href="#slide8">8</a></td>
      </tr>
      
      
      <tr id="toc-row-9">
        <th><a href="#slide9">Application Server <em>Needs</em></a></th>
        <td><a href="#slide9">9</a></td>
      </tr>
      
      
      <tr id="toc-row-10">
        <th><a href="#slide10">Data Layer Options</a></th>
        <td><a href="#slide10">10</a></td>
      </tr>
      
      
      <tr id="toc-row-11">
        <th><a href="#slide11">SQL v. NoSQL</a></th>
        <td><a href="#slide11">11</a></td>
      </tr>
      
      
      <tr id="toc-row-12">
        <th><a href="#slide12">Database Outline</a></th>
        <td><a href="#slide12">12</a></td>
      </tr>
      
      
      <tr id="toc-row-13">
        <th><a href="#slide13">Database Transactions</a></th>
        <td><a href="#slide13">13</a></td>
      </tr>
      
      
      <tr id="toc-row-14">
        <th><a href="#slide14">Database Transaction History</a></th>
        <td><a href="#slide14">14</a></td>
      </tr>
      
      
      <tr id="toc-row-15">
        <th><a href="#slide15">Database ACID Properties</a></th>
        <td><a href="#slide15">15</a></td>
      </tr>
      
      
      <tr id="toc-row-16">
        <th><a href="#slide16">Overlapping Concerns</a></th>
        <td><a href="#slide16">16</a></td>
      </tr>
      
      
      <tr id="toc-row-17">
        <th><a href="#slide17">Definition: Schedule</a></th>
        <td><a href="#slide17">17</a></td>
      </tr>
      
      
      <tr id="toc-row-18">
        <th><a href="#slide18">Conflicting Actions</a></th>
        <td><a href="#slide18">18</a></td>
      </tr>
      
      
      <tr id="toc-row-19">
        <th><a href="#slide19">Non-Conflicting Examples</a></th>
        <td><a href="#slide19">19</a></td>
      </tr>
      
      
      <tr id="toc-row-20">
        <th><a href="#slide20">Question</a></th>
        <td><a href="#slide20">20</a></td>
      </tr>
      
      
      <tr id="toc-row-21">
        <th><a href="#slide21">Answer</a></th>
        <td><a href="#slide21">21</a></td>
      </tr>
      
      
      <tr id="toc-row-22">
        <th><a href="#slide22">Dirty Read Problem</a></th>
        <td><a href="#slide22">22</a></td>
      </tr>
      
      
      <tr id="toc-row-23">
        <th><a href="#slide23">Incorrect Summary Problem</a></th>
        <td><a href="#slide23">23</a></td>
      </tr>
      
      
      <tr id="toc-row-24">
        <th><a href="#slide24">Schedule Types</a></th>
        <td><a href="#slide24">24</a></td>
      </tr>
      
      
      <tr id="toc-row-25">
        <th><a href="#slide25">Not Conflict Serializable</a></th>
        <td><a href="#slide25">25</a></td>
      </tr>
      
      
      <tr id="toc-row-26">
        <th><a href="#slide26">Why Serializable?</a></th>
        <td><a href="#slide26">26</a></td>
      </tr>
      
      
      <tr id="toc-row-27">
        <th><a href="#slide27">Serial Schedule</a></th>
        <td><a href="#slide27">27</a></td>
      </tr>
      
      
      <tr id="toc-row-28">
        <th><a href="#slide28">Database Locks</a></th>
        <td><a href="#slide28">28</a></td>
      </tr>
      
      
      <tr id="toc-row-29">
        <th><a href="#slide29">Types of Database Locks</a></th>
        <td><a href="#slide29">29</a></td>
      </tr>
      
      
      <tr id="toc-row-30">
        <th><a href="#slide30">Two-Phase Locking</a></th>
        <td><a href="#slide30">30</a></td>
      </tr>
      
      
      <tr id="toc-row-31">
        <th><a href="#slide31">Two-Phase Locking: Potential Issue</a></th>
        <td><a href="#slide31">31</a></td>
      </tr>
      
      
      <tr id="toc-row-32">
        <th><a href="#slide32">Strong Strict Two-Phase Locking</a></th>
        <td><a href="#slide32">32</a></td>
      </tr>
      
      
      <tr id="toc-row-33">
        <th><a href="#slide33">Concurrency Control in Rails</a></th>
        <td><a href="#slide33">33</a></td>
      </tr>
      
      
      <tr id="toc-row-34">
        <th><a href="#slide34">Concurrency Control in Rails</a></th>
        <td><a href="#slide34">34</a></td>
      </tr>
      
      
      <tr id="toc-row-35">
        <th><a href="#slide35">Optimistic Locking in Rails</a></th>
        <td><a href="#slide35">35</a></td>
      </tr>
      
      
      <tr id="toc-row-36">
        <th><a href="#slide36">Optimistic Locking Example</a></th>
        <td><a href="#slide36">36</a></td>
      </tr>
      
      
      <tr id="toc-row-37">
        <th><a href="#slide37">Pessimistic Locking in Rails</a></th>
        <td><a href="#slide37">37</a></td>
      </tr>
      
      
      <tr id="toc-row-38">
        <th><a href="#slide38">Pessimistic Locking Example</a></th>
        <td><a href="#slide38">38</a></td>
      </tr>
      
      
      <tr id="toc-row-39">
        <th><a href="#slide39">Pessimistic Locking Issue 1</a></th>
        <td><a href="#slide39">39</a></td>
      </tr>
      
      
      <tr id="toc-row-40">
        <th><a href="#slide40">Pessimistic Locking: Deadlock</a></th>
        <td><a href="#slide40">40</a></td>
      </tr>
      
      
      <tr id="toc-row-41">
        <th><a href="#slide41">Pessimistic Locking: Summary</a></th>
        <td><a href="#slide41">41</a></td>
      </tr>
      
      
      <tr id="toc-row-42">
        <th><a href="#slide42">Challenge 1</a></th>
        <td><a href="#slide42">42</a></td>
      </tr>
      
      
      <tr id="toc-row-43">
        <th><a href="#slide43">Challenge 2</a></th>
        <td><a href="#slide43">43</a></td>
      </tr>
      
      
      <tr id="toc-row-44">
        <th><a href="#slide44">Next Step</a></th>
        <td><a href="#slide44">44</a></td>
      </tr>
      
      
      <tr id="toc-row-45">
        <th><a href="#slide45">Demo App Database Optimizations</a></th>
        <td><a href="#slide45">45</a></td>
      </tr>
      
      
      <tr id="toc-row-46">
        <th><a href="#slide46">Demo App ActiveRecord Time</a></th>
        <td><a href="#slide46">46</a></td>
      </tr>
      
      
      <tr id="toc-row-47">
        <th><a href="#slide47">Demo App Investigation</a></th>
        <td><a href="#slide47">47</a></td>
      </tr>
      
      
      <tr id="toc-row-48">
        <th><a href="#slide48">Submission Index Controller and View</a></th>
        <td><a href="#slide48">48</a></td>
      </tr>
      
      
      <tr id="toc-row-49">
        <th><a href="#slide49">Generated SQL Statements</a></th>
        <td><a href="#slide49">49</a></td>
      </tr>
      
      
      <tr id="toc-row-50">
        <th><a href="#slide50">Number of Queries Bottleneck</a></th>
        <td><a href="#slide50">50</a></td>
      </tr>
      
      
      <tr id="toc-row-51">
        <th><a href="#slide51">Number of Queries Bottleneck</a></th>
        <td><a href="#slide51">51</a></td>
      </tr>
      
      
      <tr id="toc-row-52">
        <th><a href="#slide52">Reducing Queries in Rails</a></th>
        <td><a href="#slide52">52</a></td>
      </tr>
      
      
      <tr id="toc-row-53">
        <th><a href="#slide53">With Includes Result</a></th>
        <td><a href="#slide53">53</a></td>
      </tr>
      
      
      <tr id="toc-row-54">
        <th><a href="#slide54">SQL Explain</a></th>
        <td><a href="#slide54">54</a></td>
      </tr>
      
      
      <tr id="toc-row-55">
        <th><a href="#slide55">SQL Explain Example</a></th>
        <td><a href="#slide55">55</a></td>
      </tr>
      
      
      <tr id="toc-row-56">
        <th><a href="#slide56">Understanding the Explain Output</a></th>
        <td><a href="#slide56">56</a></td>
      </tr>
      
      
      <tr id="toc-row-57">
        <th><a href="#slide57">Explain Field: select_type</a></th>
        <td><a href="#slide57">57</a></td>
      </tr>
      
      
      <tr id="toc-row-58">
        <th><a href="#slide58">Explain Field: type</a></th>
        <td><a href="#slide58">58</a></td>
      </tr>
      
      
      <tr id="toc-row-59">
        <th><a href="#slide59">Explain Fields: possible_keys &amp; key</a></th>
        <td><a href="#slide59">59</a></td>
      </tr>
      
      
      <tr id="toc-row-60">
        <th><a href="#slide60">Explain Field: rows</a></th>
        <td><a href="#slide60">60</a></td>
      </tr>
      
      
      <tr id="toc-row-61">
        <th><a href="#slide61">SQL Optimizations</a></th>
        <td><a href="#slide61">61</a></td>
      </tr>
      
      
      <tr id="toc-row-62">
        <th><a href="#slide62">SQL Indexes</a></th>
        <td><a href="#slide62">62</a></td>
      </tr>
      
      
      <tr id="toc-row-63">
        <th><a href="#slide63">Adding Indexes in Rails</a></th>
        <td><a href="#slide63">63</a></td>
      </tr>
      
      
      <tr id="toc-row-64">
        <th><a href="#slide64">Related: Foreign Keys</a></th>
        <td><a href="#slide64">64</a></td>
      </tr>
      
      
      <tr id="toc-row-65">
        <th><a href="#slide65">Optimize the Table Structure</a></th>
        <td><a href="#slide65">65</a></td>
      </tr>
      
      
      <tr id="toc-row-66">
        <th><a href="#slide66">Directly Optimize the Query</a></th>
        <td><a href="#slide66">66</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Expos</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
</body>
</html>