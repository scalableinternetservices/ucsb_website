<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>HTTP and Application Servers</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="theme/css/print.css">
    <link rel="stylesheet" media="screen, projection" href="theme/css/screen.css">
    
    
      
      <link rel="stylesheet" href="theme/css/custom.css">
      
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="theme/js/slides.js"></script>
    
    
    
    <!-- /Javascripts -->

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-67332703-1', 'auto');
      ga('send', 'pageview');
    </script>
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide title slide-1">
          <div class="inner">
            
            <header><h1>HTTP and Application Servers</h1></header>
            
            
            <section><p><strong>CS291A</strong></p>
<p>Dr. Bryce Boe</p>
<p>October 6, 2015</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              1/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-2">
          <div class="inner">
            
            <header><h1>Today's Agenda</h1></header>
            
            
            <section><ul>
<li>TODO</li>
<li>HTTP Server Architectures</li>
<li>C10K Problem</li>
<li>Application Servers</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              2/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-3">
          <div class="inner">
            
            <header><h1>TODO</h1></header>
            
            
            <section><h2>Should be done:</h2>
<ul>
<li>Chapters 1, 2, 9-11 in
  <a href="https://hpbn.co/primer-on-latency-and-bandwidth/">HPBN</a> / Chapters 1-6 in
  the <a href="https://www.railstutorial.org/book/beginning">Ruby on Rails Tutorial</a></li>
<li>Familiarity with <a href="http://rogerdudler.github.io/git-guide/">git</a></li>
<li>Have at least 20 user stories (40 would be better) for your project</li>
</ul>
<h2>Before Tuesday's Class:</h2>
<ul>
<li>Read
  <a href="http://www.ics.uci.edu/~cs230/reading/DLB.pdf">Dynamic Load Balancing on Web-server Systems</a>
  by Cardellini, Colajanni, and Yu.</li>
</ul>
<h2>Before Next Lab</h2>
<ul>
<li>Complete at least #TEAM_MEMBERS stories that deliver value to your users
  (me).</li>
<li>Complete chapters 7 through 10 in the
  <a href="https://www.railstutorial.org/book/beginning">Ruby on Rails Tutorial</a></li>
<li>Hook TravisCI up to your repository.</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              3/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-4">
          <div class="inner">
            
            <header><h1>HTTP Server Architectures</h1></header>
            
            
            <section><ul>
<li>Single Threaded (no concurrency)</li>
<li>Process per request</li>
<li>Process pool</li>
<li>Thread per request</li>
<li>Process/thread worker pool</li>
<li>Event-driven</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              4/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-5">
          <div class="inner">
            
            <header><h1>Single Threaded HTTP Servers</h1></header>
            
            
            <section><pre><code>bind() to port 80 and listen()
loop forever
    accept() a socket connection
    while we can read from the socket
        read() a request
        process that request
        write() its response
    close() the socket connection
</code></pre>
<blockquote>
<p>What happens when another request comes in while we're within the loop?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              5/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-6">
          <div class="inner">
            
            <header><h1>Single Threaded Problem</h1></header>
            
            
            <section><p>If a single threaded web service does not process the request quickly, other
clients end up waiting or dropping their connections.</p>
<p>We are building web applications not web sites. As a result:</p>
<ul>
<li>The requests are usually more complicated than serving a file from disk.</li>
<li>It is common to have a web request doing a significant amount of computation
  and business logic.</li>
<li>It is common to have a web request result in connections to multiple external
  services, e.g., databases, and caching stores.</li>
<li>These requests can be anything: lightweight or heavyweight, IO intensive or
  CPU intensive.</li>
</ul>
<p>We can solve these problems if the thread of control that processes the request
is separate from the thread that <code>listen()</code>s and <code>accept()</code>s new connections.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              6/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-7">
          <div class="inner">
            
            <header><h1>Process per Request HTTP Server</h1></header>
            
            
            <section><p>Handle each request as a subprocess:</p>
<p><img alt="forking web server" src="img/server_forking.png" /></p>
<pre><code>bind() to port 80 and listen()
loop forever
    accept() a socket connection
    if fork() == 0  # child process
        while we can read from the socket
            read() a request
            process that request
            write() its response
        close() the socket connection
        exit()
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              7/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-8">
          <div class="inner">
            
            <header><h1>Process per Request HTTP Server</h1></header>
            
            
            <section><h2>Strengths</h2>
<ul>
<li>Simple</li>
<li>Provides easy isolation between requests</li>
<li>No threading issues (to discuss)</li>
</ul>
<h2>Weaknesses</h2>
<ul>
<li>Does each request duplicate the process memory?</li>
<li>What happens as the CPU load increases?</li>
<li>How efficient is it to fire up a process on each request?<ul>
<li>How much setup and tear down work is necessary?</li>
</ul>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              8/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-9">
          <div class="inner">
            
            <header><h1>Process Pool HTTP Server</h1></header>
            
            
            <section><p><img alt="process pool web server" src="img/server_process_pool.png" /></p>
<p>Instead of spawning a process for each request create a pool of N processes at
start-up and have them handle incoming requests when available.</p>
<p>The children processes <code>accept()</code> the incoming connections and use shared
memory to coordinate.</p>
<p>The parent process watches the load on its children and can adjust the pool
size as needed.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              9/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-10">
          <div class="inner">
            
            <header><h1>Process Pool HTTP Server</h1></header>
            
            
            <section><h2>Strengths</h2>
<ul>
<li>Provides easy isolation between requests</li>
<li>Children can die after <em>M</em> requests to avoid memory leakage</li>
<li>Process setup and tear down costs are minimized</li>
<li>More predictable behavior under high load</li>
<li>No threading issues (to discuss)</li>
</ul>
<h2>Weaknesses</h2>
<ul>
<li>More complex than process per request</li>
<li>Many processes can still mean a large amount of memory consumption</li>
</ul>
<p>This web server architecture is provided by the Apache 2.x MPM "Prefork" module.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              10/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-11">
          <div class="inner">
            
            <header><h1>Thread per Request HTTP Server</h1></header>
            
            
            <section><p>Why use multiple processes at all? Instead we can use a single process and
spawn new threads for each request.</p>
<p><img alt="http server thread per request" src="img/server_threaded.png" /></p>
<pre><code>bind() to port 80 and listen()
loop forever
    accept() a socket connection
    pthread_create()  # function that...
        while we can read from the socket
            read() a request
            process that request
            write() its response
        close() the socket connection
        # thread dies
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              11/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-12">
          <div class="inner">
            
            <header><h1>Thread per Request HTTP Server</h1></header>
            
            
            <section><h2>Strengths</h2>
<ul>
<li>Relatively simple</li>
<li>Reduced memory footprint compared to multi-processed</li>
</ul>
<h2>Weaknesses</h2>
<ul>
<li>Request handling code must be thread-safe</li>
<li>Pushing thread-safety to the application developer is not ideal</li>
<li>Setup and tear down needs to occur for each thread (or shared data
  needs to be thread-safe)</li>
<li>Memory leaks?</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              12/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide img-left slide-13">
          <div class="inner">
            
            <header><h1>Process/Thread Worker Pool Server</h1></header>
            
            
            <section><p><img alt="http process/thread worker pool" src="img/server_worker_pool.png" /></p>
<p>Combination of the two techniques.</p>
<p>Master process spawns processes, each with many threads. Master maintains
process pool.</p>
<p>Processes coordinate through shared memory to <code>accept()</code> requests.</p>
<p>Fixed threads per request, scaling is done at the process level.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              13/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-14">
          <div class="inner">
            
            <header><h1>Process/Thread Worker Pool Server</h1></header>
            
            
            <section><h2>Strengths</h2>
<ul>
<li>Faults isolated between processes, but not threads</li>
<li>Threads reduce memory footprint</li>
<li>Tunable level of isolation</li>
<li>Controlling the number of processes and threads allows for predictable
  behavior under load</li>
</ul>
<h2>Weaknesses</h2>
<ul>
<li>Requires thread-safe code</li>
<li>Uses more memory than an all-thread based approach</li>
</ul>
<p>This web server architecture is provided by the Apache 2.x MPM "Worker" module.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              14/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-15">
          <div class="inner">
            
            <header><h1>C10K Problem</h1></header>
            
            
            <section><p>Originally posed in 1999 by Dan Kegel.</p>
<blockquote>
<p>Given a 1 GHz machine with 2GB of RAM, and a gigabit Ethernet card, can we
support 10,000 simultaneous connections?</p>
</blockquote>
<h2>20,000 clients means each gets:</h2>
<ul>
<li>50 KHz of CPU</li>
<li>100 KB of RAM</li>
<li>50 Kb/second of network</li>
</ul>
<p>"It shouldn't take any more horsepower than that to take four kilobytes from
the disk and send them to the network once a second for each of twenty thousand
clients."</p>
<blockquote>
<p>What makes managing concurrent connections difficult?</p>
</blockquote>
<p>Source: <a href="http://www.kegel.com/c10k.html">http://www.kegel.com/c10k.html</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              15/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-16">
          <div class="inner">
            
            <header><h1>Each Client is...</h1></header>
            
            
            <section><ul>
<li>Reading from the network socket</li>
<li>Parsing its request</li>
<li>Opening a file on disk</li>
<li>Reading the file into memory</li>
<li>Writing the memory to network</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              16/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-17">
          <div class="inner">
            
            <header><h1>Each Client is... <strong>blocking</strong></h1></header>
            
            
            <section><ul>
<li>Reading from the network socket (<strong>blocking</strong>)</li>
<li>Parsing its request</li>
<li>Opening a file on disk  (<strong>blocking</strong>)</li>
<li>Read the file into memory  (<strong>blocking</strong>)</li>
<li>Write the memory to network  (<strong>blocking</strong>)</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              17/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-18">
          <div class="inner">
            
            <header><h1>Waiting on I/O</h1></header>
            
            
            <section><p>Every time a process/thread is waiting on I/O it is not runnable, and it is not
cost-free:</p>
<ul>
<li>Each process/thread is considered every time the scheduler makes a decision</li>
<li>Memory is occupied by the process, and its last load may have evicted other
  processes' memory from the cache</li>
</ul>
<p>Massive concurrency slows down all processes/threads.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              18/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-19">
          <div class="inner">
            
            <header><h1>How can we not wait on I/O?</h1></header>
            
            
            <section><p>Blocking system calls cause this problem.</p>
<blockquote>
<p>Can we accomplish our desired tasks without blocking?</p>
</blockquote>
<h2>Yes! Asynchronous I/O</h2>
<ul>
<li><code>select()</code>: Provided a list of file descriptors, block only until at least
  one is ready for I/O (only usable up to 1024 file descriptors on Linux).</li>
<li><code>epoll_*()</code>: Register to listen for events on file descriptors. Again block
  only until at least one of the registered descriptors is ready for I/O</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              19/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-20">
          <div class="inner">
            
            <header><h1>Select example</h1></header>
            
            
            <section><p>Assume we have a list of sockets called fd_list.</p>
<pre><code>loop forever:
    select(fd_list, ...) // block until something has I/O to handle
    for fd in fd_list
        if fd is ready for IO
            handle_io(fd)
        else do nothing
</code></pre>
<h2>handle_io</h2>
<ul>
<li>can include socket acceptance</li>
<li>shouldn't make any blocking calls<ul>
<li>Use their non-blocking variants</li>
<li>Rely on select/epoll to tell you when I/O is ready</li>
</ul>
</li>
<li>should avoid excessive computation<ul>
<li>Use a separate thread, process, or worker pool for such purposes</li>
</ul>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              20/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-21">
          <div class="inner">
            
            <header><h1>Event Driven Systems</h1></header>
            
            
            <section><p>Systems that operate in such a manner are called event driven system.</p>
<p>Often such systems can accomplish everything using only a single process and
thread, of course more may be needed for CPU-bound segments.</p>
<p>Well used examples:</p>
<ul>
<li>NGINX</li>
<li>Tengine (fork of NGINX)</li>
<li>lighttpd</li>
<li>netty (java)</li>
<li>node.js (JavaScript)</li>
<li>eventmachine (ruby)</li>
<li>twisted (python)</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              21/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-22">
          <div class="inner">
            
            <header><h1>Event Driven HTTP Servers</h1></header>
            
            
            <section><h2>Strengths</h2>
<ul>
<li>High performance under high load</li>
<li>Predictable performance under high load</li>
<li>No need to be thread-proof (unless specifically adding thread-concurrency)</li>
</ul>
<h1>Weaknesses</h1>
<ul>
<li>Poor isolation<ul>
<li>What happens if a bug causes an infinite loop?</li>
</ul>
</li>
<li>Fewer extensions, since code cannot use blocking syscalls</li>
<li>Very complex</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              22/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-23">
          <div class="inner">
            
            <header><h1>Event Machine (Ruby) Example</h1></header>
            
            
            <section><p>Event driven code is dominated by callbacks:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="p">{</span>
  <span class="n">page</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">HttpRequest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;http://google.ca/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
  <span class="n">page</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span> <span class="nb">p</span> <span class="s2">&quot;Google is down! terminate?&quot;</span> <span class="p">}</span>
  <span class="n">page</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span>
    <span class="n">a</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">HttpRequest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;http://google.ca/search?q=em&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
    <span class="n">a</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span> <span class="c1"># callback nesting, ad infinitum }</span>
    <span class="n">a</span><span class="o">.</span><span class="n">errback</span>  <span class="p">{</span> <span class="c1"># error-handling code }</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              23/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-24">
          <div class="inner">
            
            <header><h1>Callback Hell</h1></header>
            
            
            <section><p><img alt="Yo dawg, I heard you like JavaScript" src="img/callback_hell.png" /></p>
<p>It <em>can</em> very easily become complicated.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              24/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-25">
          <div class="inner">
            
            <header><h1>HTTP Server Architectures Review</h1></header>
            
            
            <section><ul>
<li>Single Threaded</li>
<li>Process per request<ul>
<li>Greatest isolation</li>
<li>Largest memory footprint</li>
</ul>
</li>
<li>Thread per request<ul>
<li>Less isolation</li>
<li>Smaller memory footprint</li>
</ul>
</li>
<li>Process/thread worker pool<ul>
<li>Tunable compromise between processes and threads</li>
</ul>
</li>
<li>Event-driven<ul>
<li>Great performance under high load</li>
<li>Difficult to extend</li>
<li>Reduced isolation</li>
</ul>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              25/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-26">
          <div class="inner">
            
            <header><h1>Application Servers</h1></header>
            
            
            <section><p>We are building web applications, so we will require complex server-side logic.</p>
<p>We <em>can</em> extend our HTTP servers to provide this logic through modules, but
there are benefits to separating application servers to distinct process(es).</p>
<ul>
<li>Application logic will be dynamic</li>
<li>Application logic regularly uses high level (slow) languages</li>
<li>Security concerns are easier (HTTP server can shield app server from
  malformed requests)</li>
<li>Setup costs can be amortized if the app server is running continuously</li>
</ul>
<p>Instead we can have our HTTP server forward requests to the application
server(s).</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              26/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-27">
          <div class="inner">
            
            <header><h1>Inter-server Communication</h1></header>
            
            
            <section><blockquote>
<p>How does an HTTP Server communicate with the application server(s)?</p>
</blockquote>
<p>A few different ways:</p>
<h2>CGI</h2>
<p>Spawn a process, pass HTTP headers as ENV variables and utilize STDOUT as the
response.</p>
<h2>FastCGI, SCGI</h2>
<p>Modifications to CGI to allow for persistent application server processes
(amortizes setup time).</p>
<h2>HTTP</h2>
<p>Communicate via the HTTP protocol to a long-running process. (Essentially a
reverse-proxy configuration).</p>
<blockquote>
<p>Does it make sense to do this?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              27/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-28">
          <div class="inner">
            
            <header><h1>Application Server Architectures</h1></header>
            
            
            <section><blockquote>
<p>What architecture should we use for our application server?</p>
</blockquote>
<p>We have the same trade-offs to consider as with HTTP servers
(e.g. threads/processes/workers).</p>
<h2>Up Next</h2>
<p>Let's take a quantitative look at various approaches with Ruby application
servers.</p>
<p>We will not consider evented ruby application servers (e.g., EventMachine)
because Rails will not run on such application servers.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              28/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-29">
          <div class="inner">
            
            <header><h1>Our Test Setup</h1></header>
            
            
            <section><p><img alt="Demo App" src="img/demo_app.png" /></p>
<p>The Demo App is a link sharing website with:</p>
<ul>
<li>Multiple communities</li>
<li>Each community can have many submissions</li>
<li>Each submission can have a tree of comments</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              29/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-30">
          <div class="inner">
            
            <header><h1>Simulated Users</h1></header>
            
            
            <section><p>Using Tsung (erlang-based test framework) we will simulate multiple users
visiting the Demo App web service. Each user will:</p>
<pre><code>Visit the homepage (/)
  Wait randomly between 0 and 2 seconds
Request community creation form
  Wait randomly between 0 and 2 seconds
Submit new community form
Request new link submission form
  Wait randomly between 0 and 2 seconds
Submit new link submission form
  Wait randomly between 0 and 2 seconds
Delete the link
  Wait randomly between 0 and 2 seconds
Delete the community
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              30/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-31">
          <div class="inner">
            
            <header><h1>Test Process</h1></header>
            
            
            <section><p>There are six phases of testing each lasting 60 seconds:</p>
<ol>
<li>(0-59s) Every second a new simulated user arrives</li>
<li>(60-119s) Every second 1.5 new simulated users arrive</li>
<li>(120-179s) Every second 2 new simulated users arrive</li>
<li>(180-239s) Every second 2.5 new simulated users arrive</li>
<li>(240-299s) Every second 3 new simulated users arrive</li>
<li>(300-359s) Every second 3.5 new simulated users arrive</li>
</ol>
<p><strong>Note</strong>: Each user corresponds to seven requests and a user may wait up to ten
seconds with the delays.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              31/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-32">
          <div class="inner">
            
            <header><h1>Test Environment</h1></header>
            
            
            <section><p>All tests were conducted on a single Amazon EC2 m3-medium instance.</p>
<ul>
<li>1 vCPU</li>
<li>3.75 GB RAM</li>
</ul>
<p>The tests used the <code>Puma</code> web application server (unless otherwise specified).</p>
<p>The <code>database_optimizations</code> branch of the demo app was used to run the tests:
<a href="https://github.com/scalableinternetservices/demo/tree/database_optimizations">https://github.com/scalableinternetservices/demo/tree/database_optimizations</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              32/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-33">
          <div class="inner">
            
            <header><h1>Single Thread/Process (Users)</h1></header>
            
            
            <section><p><img alt="Single Thread/Process Users" src="img/demo_single_users.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              33/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-34">
          <div class="inner">
            
            <header><h1>Single Thread/Process (Page Load)</h1></header>
            
            
            <section><p>Decrease in performance around 60s (1.5 new users per second)</p>
<p><img alt="Single Thread/Process Page Load" src="img/demo_single_page_load.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              34/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-35">
          <div class="inner">
            
            <header><h1>Four Processes (Users)</h1></header>
            
            
            <section><p><img alt="Four Processes Users" src="img/demo_four_users.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              35/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-36">
          <div class="inner">
            
            <header><h1>Four Processes (Page Load)</h1></header>
            
            
            <section><p>Decrease in performance around 240s (3 new users per second)</p>
<p><img alt="Four Processes Page Load" src="img/demo_four_load.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              36/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-37">
          <div class="inner">
            
            <header><h1>Sixteen Processes (Users)</h1></header>
            
            
            <section><p><img alt="Sixteen Processes Users" src="img/demo_sixteen_users.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              37/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-38">
          <div class="inner">
            
            <header><h1>Sixteen Processes (Page Load)</h1></header>
            
            
            <section><p>Little improvement over 4 processes</p>
<p><img alt="Sixteen Processes Page Load" src="img/demo_sixteen_load.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              38/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-39">
          <div class="inner">
            
            <header><h1>Threads instead of processes?</h1></header>
            
            
            <section><blockquote>
<p>What do you think will happen?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              39/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-40">
          <div class="inner">
            
            <header><h1>Four Threads (Users)</h1></header>
            
            
            <section><p><img alt="Four Threads Users" src="img/demo_four_threads_users.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              40/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-41">
          <div class="inner">
            
            <header><h1>Four Threads (Page Load)</h1></header>
            
            
            <section><p>Still decrease in performance around 240s, but more
stable until then.</p>
<p><img alt="Four Threads Page Load" src="img/demo_four_threads_load.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              41/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-42">
          <div class="inner">
            
            <header><h1>32 Threads (Users)</h1></header>
            
            
            <section><p><img alt="32 Threads Users" src="img/demo_32_threads_users.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              42/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-43">
          <div class="inner">
            
            <header><h1>32 Threads (Page Load)</h1></header>
            
            
            <section><p>Decrease in performance beginning around 300s (3.5 new users per second)</p>
<p><img alt="32 Threads Page Load" src="img/demo_32_threads_load.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              43/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-44">
          <div class="inner">
            
            <header><h1>Side note: Ruby interpreters</h1></header>
            
            
            <section><p>There are different versions of the Ruby interpreter. Different workloads may
benefit from using different interpreters.</p>
<h2>MRI (Matz's Ruby Interpreter)</h2>
<ul>
<li>The reference version</li>
<li>Written in C</li>
<li>Has a global interpreter lock (GIL) that prevents true thread-concurrency</li>
</ul>
<h2>JRuby</h2>
<ul>
<li>Written in Ruby</li>
<li>Does not have GIL</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              44/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-45">
          <div class="inner">
            
            <header><h1>Application Server Options</h1></header>
            
            
            <section><p>In this class you will be able to compare the performance of a handful of
application servers:</p>
<h2>via elastic beanstalk configuration (formerly cloud formation templates)</h2>
<ul>
<li>Puma (worker pool)</li>
<li>Phusion Passenger (worker pool)</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              45/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-46">
          <div class="inner">
            
            <header><h1>Puma</h1></header>
            
            
            <section><p>Originally designed for Rubinius (GIL-less ruby interpreter).</p>
<p>Claims to require less memory than others (for the server itself)</p>
<p>Specifically made to work with thread-based parallelism, but also supports
multiple processes each with a tunable number of threads.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              46/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-47">
          <div class="inner">
            
            <header><h1>Phusion Passenger</h1></header>
            
            
            <section><p>Passenger is a ruby web application server that can be added as a module to
either Apache or NGINX.</p>
<p>Passenger works as a worker pool adjusting the number of processes that
handle requests. Originally did not support threads within the processes.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              47/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide slide-48">
          <div class="inner">
            
            <header><h1>Puma and Passenger</h1></header>
            
            
            <section><p>Both Puma and Phusion Passenger:</p>
<ul>
<li>are relatively easy to configure</li>
<li>enable processes to be forked after ruby/rails is loaded</li>
</ul>
<blockquote>
<p>Why might you want to wait to load the application prior to forking?</p>
</blockquote></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              48/49
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: 05_web_and_application_servers.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-49">
          <div class="inner">
            
            <header><h1>Thread Safety Note</h1></header>
            
            
            <section><p>If you can use thread-parallelism, do it! But, making your code thread safe
isn't always obvious.</p>
<h2>Old example: pp/models/order.rb</h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Order</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">klass</span><span class="p">:</span> <span class="no">User</span>
<span class="k">end</span>
</pre></div>
</td></tr></table>
<p>The above code may result in <em>autoloading</em> the <code>user.rb</code> for the <code>User</code>
model. In versions of ruby prior to 2.0 (February 2013) autoloading was not
thread safe.</p>
<blockquote>
<p>What else might not be thread safe?</p>
</blockquote>
<p>Things to consider:</p>
<ul>
<li>Your code</li>
<li>Your many dependencies</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="05_web_and_application_servers.md">05_web_and_application_servers.md</a>
            </aside>
            
            <aside class="page_number">
              49/49
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1">HTTP and Application Servers</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide2">Today's Agenda</a></th>
        <td><a href="#slide2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide3">TODO</a></th>
        <td><a href="#slide3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide4">HTTP Server Architectures</a></th>
        <td><a href="#slide4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide5">Single Threaded HTTP Servers</a></th>
        <td><a href="#slide5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide6">Single Threaded Problem</a></th>
        <td><a href="#slide6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide7">Process per Request HTTP Server</a></th>
        <td><a href="#slide7">7</a></td>
      </tr>
      
      
      <tr id="toc-row-8">
        <th><a href="#slide8">Process per Request HTTP Server</a></th>
        <td><a href="#slide8">8</a></td>
      </tr>
      
      
      <tr id="toc-row-9">
        <th><a href="#slide9">Process Pool HTTP Server</a></th>
        <td><a href="#slide9">9</a></td>
      </tr>
      
      
      <tr id="toc-row-10">
        <th><a href="#slide10">Process Pool HTTP Server</a></th>
        <td><a href="#slide10">10</a></td>
      </tr>
      
      
      <tr id="toc-row-11">
        <th><a href="#slide11">Thread per Request HTTP Server</a></th>
        <td><a href="#slide11">11</a></td>
      </tr>
      
      
      <tr id="toc-row-12">
        <th><a href="#slide12">Thread per Request HTTP Server</a></th>
        <td><a href="#slide12">12</a></td>
      </tr>
      
      
      <tr id="toc-row-13">
        <th><a href="#slide13">Process/Thread Worker Pool Server</a></th>
        <td><a href="#slide13">13</a></td>
      </tr>
      
      
      <tr id="toc-row-14">
        <th><a href="#slide14">Process/Thread Worker Pool Server</a></th>
        <td><a href="#slide14">14</a></td>
      </tr>
      
      
      <tr id="toc-row-15">
        <th><a href="#slide15">C10K Problem</a></th>
        <td><a href="#slide15">15</a></td>
      </tr>
      
      
      <tr id="toc-row-16">
        <th><a href="#slide16">Each Client is...</a></th>
        <td><a href="#slide16">16</a></td>
      </tr>
      
      
      <tr id="toc-row-17">
        <th><a href="#slide17">Each Client is... <strong>blocking</strong></a></th>
        <td><a href="#slide17">17</a></td>
      </tr>
      
      
      <tr id="toc-row-18">
        <th><a href="#slide18">Waiting on I/O</a></th>
        <td><a href="#slide18">18</a></td>
      </tr>
      
      
      <tr id="toc-row-19">
        <th><a href="#slide19">How can we not wait on I/O?</a></th>
        <td><a href="#slide19">19</a></td>
      </tr>
      
      
      <tr id="toc-row-20">
        <th><a href="#slide20">Select example</a></th>
        <td><a href="#slide20">20</a></td>
      </tr>
      
      
      <tr id="toc-row-21">
        <th><a href="#slide21">Event Driven Systems</a></th>
        <td><a href="#slide21">21</a></td>
      </tr>
      
      
      <tr id="toc-row-22">
        <th><a href="#slide22">Event Driven HTTP Servers</a></th>
        <td><a href="#slide22">22</a></td>
      </tr>
      
      
      <tr id="toc-row-23">
        <th><a href="#slide23">Event Machine (Ruby) Example</a></th>
        <td><a href="#slide23">23</a></td>
      </tr>
      
      
      <tr id="toc-row-24">
        <th><a href="#slide24">Callback Hell</a></th>
        <td><a href="#slide24">24</a></td>
      </tr>
      
      
      <tr id="toc-row-25">
        <th><a href="#slide25">HTTP Server Architectures Review</a></th>
        <td><a href="#slide25">25</a></td>
      </tr>
      
      
      <tr id="toc-row-26">
        <th><a href="#slide26">Application Servers</a></th>
        <td><a href="#slide26">26</a></td>
      </tr>
      
      
      <tr id="toc-row-27">
        <th><a href="#slide27">Inter-server Communication</a></th>
        <td><a href="#slide27">27</a></td>
      </tr>
      
      
      <tr id="toc-row-28">
        <th><a href="#slide28">Application Server Architectures</a></th>
        <td><a href="#slide28">28</a></td>
      </tr>
      
      
      <tr id="toc-row-29">
        <th><a href="#slide29">Our Test Setup</a></th>
        <td><a href="#slide29">29</a></td>
      </tr>
      
      
      <tr id="toc-row-30">
        <th><a href="#slide30">Simulated Users</a></th>
        <td><a href="#slide30">30</a></td>
      </tr>
      
      
      <tr id="toc-row-31">
        <th><a href="#slide31">Test Process</a></th>
        <td><a href="#slide31">31</a></td>
      </tr>
      
      
      <tr id="toc-row-32">
        <th><a href="#slide32">Test Environment</a></th>
        <td><a href="#slide32">32</a></td>
      </tr>
      
      
      <tr id="toc-row-33">
        <th><a href="#slide33">Single Thread/Process (Users)</a></th>
        <td><a href="#slide33">33</a></td>
      </tr>
      
      
      <tr id="toc-row-34">
        <th><a href="#slide34">Single Thread/Process (Page Load)</a></th>
        <td><a href="#slide34">34</a></td>
      </tr>
      
      
      <tr id="toc-row-35">
        <th><a href="#slide35">Four Processes (Users)</a></th>
        <td><a href="#slide35">35</a></td>
      </tr>
      
      
      <tr id="toc-row-36">
        <th><a href="#slide36">Four Processes (Page Load)</a></th>
        <td><a href="#slide36">36</a></td>
      </tr>
      
      
      <tr id="toc-row-37">
        <th><a href="#slide37">Sixteen Processes (Users)</a></th>
        <td><a href="#slide37">37</a></td>
      </tr>
      
      
      <tr id="toc-row-38">
        <th><a href="#slide38">Sixteen Processes (Page Load)</a></th>
        <td><a href="#slide38">38</a></td>
      </tr>
      
      
      <tr id="toc-row-39">
        <th><a href="#slide39">Threads instead of processes?</a></th>
        <td><a href="#slide39">39</a></td>
      </tr>
      
      
      <tr id="toc-row-40">
        <th><a href="#slide40">Four Threads (Users)</a></th>
        <td><a href="#slide40">40</a></td>
      </tr>
      
      
      <tr id="toc-row-41">
        <th><a href="#slide41">Four Threads (Page Load)</a></th>
        <td><a href="#slide41">41</a></td>
      </tr>
      
      
      <tr id="toc-row-42">
        <th><a href="#slide42">32 Threads (Users)</a></th>
        <td><a href="#slide42">42</a></td>
      </tr>
      
      
      <tr id="toc-row-43">
        <th><a href="#slide43">32 Threads (Page Load)</a></th>
        <td><a href="#slide43">43</a></td>
      </tr>
      
      
      <tr id="toc-row-44">
        <th><a href="#slide44">Side note: Ruby interpreters</a></th>
        <td><a href="#slide44">44</a></td>
      </tr>
      
      
      <tr id="toc-row-45">
        <th><a href="#slide45">Application Server Options</a></th>
        <td><a href="#slide45">45</a></td>
      </tr>
      
      
      <tr id="toc-row-46">
        <th><a href="#slide46">Puma</a></th>
        <td><a href="#slide46">46</a></td>
      </tr>
      
      
      <tr id="toc-row-47">
        <th><a href="#slide47">Phusion Passenger</a></th>
        <td><a href="#slide47">47</a></td>
      </tr>
      
      
      <tr id="toc-row-48">
        <th><a href="#slide48">Puma and Passenger</a></th>
        <td><a href="#slide48">48</a></td>
      </tr>
      
      
      <tr id="toc-row-49">
        <th><a href="#slide49">Thread Safety Note</a></th>
        <td><a href="#slide49">49</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Expos</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
</body>
</html>