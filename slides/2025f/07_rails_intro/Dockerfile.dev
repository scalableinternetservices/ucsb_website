FROM ruby:3.4.5

# Install system dependencies
RUN apt-get update -qq && apt-get install -y \
    build-essential \
    default-mysql-client \
    default-libmysqlclient-dev \
    git \
    curl \
    vim \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Create a basic Gemfile for Rails development
RUN echo "source 'https://rubygems.org'" > Gemfile && \
    echo "gem 'rails', '~> 7.0'" >> Gemfile && \
    echo "gem 'mysql2', '~> 0.5'" >> Gemfile && \
    echo "gem 'puma', '~> 5.0'" >> Gemfile && \
    echo "gem 'bootsnap', '>= 1.4.4', require: false" >> Gemfile

# Install gems
RUN bundle config --global frozen 0 && \
    bundle config --global build.mysql2 --with-mysql-config=/usr/bin/mysql_config && \
    bundle install

# Create a non-root user
RUN groupadd -r rails && useradd -r -g rails rails
RUN chown -R rails:rails /app
USER rails

# Expose port 3000
EXPOSE 3000

# Default command (can be overridden in docker-compose)
CMD ["rails", "server", "-b", "0.0.0.0", "-p", "3000"]
